language: go
sudo: required
go:
- 1.11.x
dist: trusty
addons:
  sonarcloud:
    organization: paysuper
stages:
  - test
  - name: deploy
    if: branch in (develop)
jobs:
  include:
  - stage: test
    cache:
      directories:
      - $HOME/gopath/pkg/mod  
    services:
    - rabbitmq
    - redis-server
    env:
    - MONGODB=ubuntu1604-4.2.0-rc2
    - GO111MODULE=on
    - MONGO_DSN=mongodb://localhost:27017/paysuper_test
    - CENTRIFUGO_SECRET=secret
    - CENTRIFUGO_API_SECRET=api_secret
    - CARD_PAY_API_URL=https://sandbox.cardpay.com
    - CARD_PAY_API_SANDBOX_URL=https://sandbox.cardpay.com
    - CUSTOMER_COOKIE_PUBLIC_KEY="LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUlJQ0lqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FnOEFNSUlDQ2dLQ0FnRUF0djhRMFJwRWpHaWxVMUtLNktuWApUTWJIeWhiUDhXd3kvMloybW9WNW1nL0xkZFhJUm9qTTVzKzdvaHBuUEVHd0pYbWoveHBERnhuWHVWQVk2N2JKCm8raVBkWFBBT2Y5VG5DNkhRMFNtZ3JFYkpXcGxTZFNsTFordHptQnBrYjJmQm5Iai9rSlQwK0lxTHFNSXpzbzIKT2o2cUZnaVBMaHFDYkNWMHBNMEpvVmZFb21kdVdjZ0ZBWjdoaWo3UHhSZ3lTOFo2aGlsYVU1YU1ITlJ5dUNDSgpNNCtqaEtDL01rRUtmYy9TTlRVcVpsUXFqMXdkOXp0aytDR0Y5ZTdiN25vbktWSkdTa2NOTmQxNGV5OGg4QUFTCmpHb0ZSOE9JTFBlK0svTk5kZE5CU1NsWGdDeUpVQUlEYVp2ekQrZmVsNCtZUUhDc3F1bVJ4TGJqWHFOUlVtQkQKVFRnNW9UYW92T3o5bGhFdVdMYlFORWFqaC9oZktiVnd0L2pmM0NIc2JNTk9peFVXem1Ua3VFalJienJma0lXegpGc2F3SkJjOFVzdU5SQUtXS1JJUVl4aVA1ZTdZUXJycGVPRjRONFZQMEhzVmYzT2ZzQzFORC9DcW4vaFhyTjdRCnNhNlk2emF1SVdJd2ZoMUVLR1NZcHlnVUZyNFFiK0tMNjgvUkIyY1RjMjlBVCtTK3pSdnhiaTNJeXNLcFFyRWwKSVdsa0E0cU10VHM1OUZKT2E3MUwxSUNHTmJiZk5TRU5BSW5XekI2cnhJZzVnUGxEQTFHQkZnOEVtSTVSNjNRSgpyV1hnQjNZQ0hZd1NSOHdGMzFoM2RsRDIvVjZ5WmdOd3ZwSW1rWEZ3bEowNklOKzRCMjZPakFjcHRaZkxsWVRaCnpzZXY1ZFJSNUVpVS9sRVZZK0tzWFBrQ0F3RUFBUT09Ci0tLS0tRU5EIFBVQkxJQyBLRVktLS0tLQo="
    - CUSTOMER_COOKIE_PRIVATE_KEY="LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlKS0FJQkFBS0NBZ0VBdHY4UTBScEVqR2lsVTFLSzZLblhUTWJIeWhiUDhXd3kvMloybW9WNW1nL0xkZFhJClJvak01cys3b2hwblBFR3dKWG1qL3hwREZ4blh1VkFZNjdiSm8raVBkWFBBT2Y5VG5DNkhRMFNtZ3JFYkpXcGwKU2RTbExaK3R6bUJwa2IyZkJuSGova0pUMCtJcUxxTUl6c28yT2o2cUZnaVBMaHFDYkNWMHBNMEpvVmZFb21kdQpXY2dGQVo3aGlqN1B4Umd5UzhaNmhpbGFVNWFNSE5SeXVDQ0pNNCtqaEtDL01rRUtmYy9TTlRVcVpsUXFqMXdkCjl6dGsrQ0dGOWU3Yjdub25LVkpHU2tjTk5kMTRleThoOEFBU2pHb0ZSOE9JTFBlK0svTk5kZE5CU1NsWGdDeUoKVUFJRGFadnpEK2ZlbDQrWVFIQ3NxdW1SeExialhxTlJVbUJEVFRnNW9UYW92T3o5bGhFdVdMYlFORWFqaC9oZgpLYlZ3dC9qZjNDSHNiTU5PaXhVV3ptVGt1RWpSYnpyZmtJV3pGc2F3SkJjOFVzdU5SQUtXS1JJUVl4aVA1ZTdZClFycnBlT0Y0TjRWUDBIc1ZmM09mc0MxTkQvQ3FuL2hYck43UXNhNlk2emF1SVdJd2ZoMUVLR1NZcHlnVUZyNFEKYitLTDY4L1JCMmNUYzI5QVQrUyt6UnZ4YmkzSXlzS3BRckVsSVdsa0E0cU10VHM1OUZKT2E3MUwxSUNHTmJiZgpOU0VOQUluV3pCNnJ4SWc1Z1BsREExR0JGZzhFbUk1UjYzUUpyV1hnQjNZQ0hZd1NSOHdGMzFoM2RsRDIvVjZ5ClpnTnd2cElta1hGd2xKMDZJTis0QjI2T2pBY3B0WmZMbFlUWnpzZXY1ZFJSNUVpVS9sRVZZK0tzWFBrQ0F3RUEKQVFLQ0FnQXI1bUM0YVI3TXVFWUJDU285eXBEVjRGSUpqeE52alU5bXFjUUdLY01VVEhtNDJRSmt1V2krYmxOSwovaDZKL0JBdnpWQ2tZRDU4Q2owUVBjRGN1MHNBUVVnNUd2MmdiRG80bTRqamdGS1p3N2NKY002L3VYMnV4a0hCCjRxc3d4VmFqQ3l0dzBhU2VqZ0Vra3dRSDU4YStqazNyWHo1S0J4NEdwNjJsNDNKTi9HbzFzNjVyWjJxY0N1dDgKYUxrYlJVUzduTy9EdzZQaHJab0xTSVFFMi9sT0gwVlJDZWNVUFRveEdHd0xTNmZTU0pxMUxab2F0MnJ2Zzh0SgpSbllJYmRGN1BqdVNraHovTVJRNEtRUnhPUE02TUN6NEhGWk13MW9oM1FwV0c4bnJyVGxLakdTY2h2OGVsTVRvCnFlMWlXcFpoenlYOUVtOWZ5NmdjQ2YzMlR4V1Z4dWI0dSsyQW4xdlVZUmJaeTBoUlZMeUVGQkVoRzFXZ3haMmcKU1hoWi9KM1hIV2xjQTFpZCtiZ3NrM0dQSjNCWC9pejA0TGgzbmtqdzd6MmY4cUpJazRjQytaZHpUWFc4VDF0bwpDdWhGTkpycEdoRDJVSllQSTNUTUNuY2cxNWF1Nkd1Qk9sVVQ1Skxpb2l1cVJCQVZaYmxoVHZPSmtSd0s0UlQyClNlQlB6UkkzK3lTeTJMK1NnaVdKWGordGxPckZuTmdLN1F6bGdOalhRK3dobHVSK0FlTHN2YlZKaTRqL3hGWDAKcktvMDRwclVCakVUeDJnV1YxMmpMcGppVC9GWWJyMHF4MTJzSXh4dmsxdDFzTEUyUkJmVkxmQlJndlBBcDZjcAo3b1V6bHAzZXJVY2YwMXlZVzhXV3R5Q1RlKzk3MnRPcTQ1RzNYV0w2MWU4Y243cC9BUUtDQVFFQTNpK2EyQytWCkxvZUhQdkxlek5QbXZBN2txcU5weUt4em1ZQmpFY2swKy9xNml1cnVoTGRMenp0VmVYRmxqV21oeG50R0dWWk0KRzJXTTB4QkJ0R2pUWDMrUVNnRkFtQi9KdXZlWEE1VGhKWnE0ZHpTL1dERzRYdENTaTRBZjREK3R1ck5vd1lFdwpyYmRiek02eVpWbndRM2R6L0o1YUpsOVUwcEp3VjBYZ3JKZENwK0JJUjJCR1NMR0I0SFRmYlNIRzNUTjJMc2hECmhOU3BYRkNZUnkxcXYweGhkN3VXYXMvOFpHekYvOU05Q1FRaDJoNkd4N3lUSUFwZ1FJMGVsL1F4SklFdGFOeFkKeU0wZUlEa1R2aGROWFFJQTFxK1J1U0RJQ09wcUdOSTQ3UXNjNU1RdG5zK3p0TVBScnkyOW5MVFMzbE0raENEbQpzcE5McW54VE01VmJzUUtDQVFFQTB0aWc0UmRKTlNnQWVpL1YrYmFKY2Y3enUxU1A0Zm0wdEZTcG9pY0JIZzJUCkVVL1dLTnFuQmRoTldKbEdlTVJ2VTIzbnhFemREb1dWUDhPcGErSE5UdGM5REFCaWpHb2JjbElBb3MvZmRjaHoKbWdDMGJpQ25uOXNxK1hFMUp4WUo3VWRvZ1dIOGY5M2ZnU3dsN0E3WitEUXVLaUdLaWNURkpqY0RNdjgxZUNaQQpEUVRaV1FGanlid2tEaDV3N3dLeG1qTFY1YmdYdkwyTFhSclJTNTU2Mkg3TEZkaGZXNkdmbC93NllPaFV2d0oxCi83TFZDMUVSMTE0WEpkL2hWSVNZQ0ZxdzhkRkVzMys4enBBOUJ3QWo2cVE4S3l5T0Z4a3BRREZaUGY1czgzazIKUnBzd1RHYVFSNy8xbk9GRyt3UlM3Q05HOXFBZlh3LzltamxIcklnUHlRS0NBUUFLV05VeE5DWVNZS1ZmdlJlNwpHak1vbHRqM1NWem54NEFxcWR2elBCZUhsSW1UWnBWdEFNdzYvbHhncDNNL1BxZ1dBaStsaG10TTYxRy9rb1k4CnpKVHJZWmxxbU54Vk9VVy91MEFCSHJITmVvTVVxaFF2RzBHbXlMZktYMUVjdEZwMjAxd1JodDZwZUZ5Q0VTNGwKb2lhYVBibmREZExNN3F1WWt0RkFmelNUVlFmNW9XdzhSck4vTnlVQk92QWN1UEgxNHl1aHlobTYyZHg1UEJlYgpXUFlicW9idmVJRHN3SHJVZ214R0dhUkNBenRBV1NPVnNhWjRXNE5YL2pwcWdTaTR0bnRTNHRBUHFkMjVTbThzCjd4RGZQL1NpQ3RNU2VBQll5ZkhlN2d0UW5xL2R4M1VJYkV2R0kwaGtqQkRFZDNkS2V6M3lFVVl0RXNiM1RZcmkKWUJaQkFvSUJBUUNUOW0vWDVrWjZwaXJIbEdBOTBFcGVGRU9vdDZ3Tk1mWU5Bc2pVUVRqNGhTQXE2dkxvVXFFWgphZlRGY3pMUU4xSEVvNEVjOGEvRHJCelQxWlJFWC81N0VITUh4QkZrWm1ZQ2NPZC9XZytBRVg2R21XNEZScWM3CmVFdU5KMVBjclF1a1Z4TlFrSm5vaGFSK2VxUFdKNG54TTNVZUhkR2g0dE5UZ1JHZXJSZ3h5KzN3OVBFdUU5cWEKVEl5azE5bjY4TkgvMnlMZUJiV3F2djFaQmlQUVJGUURMOStHNGdQeFF0ZkRpYjdTR05pMy9wc2VLTHAzS1pveQpvQlh3ZjA4YXg3NEZSdGVicTNiaDNJZDhFaDZ4bGZpZWhraXZKNkpETldZTVpWVXlPeVRzSzZqYUhiZmtOYW1VCm9ISlZlSVllUzZlQmpUUVVpTVBiSzFhVjd4S01VaU41QW9JQkFIVytSZUc2blJKNkdoU08zcERjS3hkU0xWeWkKQTJTQVFvNiswTTJTVFFHV0MzVTZJcGRTN3NGUTkzaHFwVDhWTE5PTlREVVNxTVBLbHI5a3B1TjJ6VnN2NWh2MgpydmE1dWpLUzFRNEtZMjREaU41TjN2WElHbzg5OGVlQkJFSEJpTVhEOUMwTWZkSVhYWm91SUNUblFqSXVrS0xXCjFhU3hKVUZDMURJMGpZejliaEEzS1lnd2g5LzdsN0I4eVRGR1gxb2ZIYjZlMCs0b2w1SjBJZldKTDVDM091aXYKWnFNVGVndXdUeHRmZTdTWFo1ZkIrSTluMFF4aklhSnRVM1ltdHdqVEt0S3Uyd1craWJ1b0lXMlU5bUFSdStNWAo5UDlhbU5oN2wxMWI2dVcyV041Q2JsV29mc2lUR1lFc0l3amxOak1DVUFCQXd3eDNHcWN4UnZGV2hBOD0KLS0tLS1FTkQgUlNBIFBSSVZBVEUgS0VZLS0tLS0="
    - ORDER_VIEW_UPDATE_BATCH_SIZE=5
    - EMAIL_NOTIFICATION_FINANCIER_RECIPIENT=finance@paysuper.com
    - CACHE_REDIS_ADDRESS="127.0.0.1:6379"
    - EMAIL_ONBOARDING_ADMIN_RECIPIENT=test@protocol.one
    - USER_INVITE_TOKEN_SECRET=Secret
    install:
    - wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-${MONGODB}.tgz
    - tar xzf mongodb-linux-x86_64-${MONGODB}.tgz
    - "${PWD}/mongodb-linux-x86_64-${MONGODB}/bin/mongod --version"
    before_script:
    - mkdir ${PWD}/mongodb-linux-x86_64-${MONGODB}/data
    - "${PWD}/mongodb-linux-x86_64-${MONGODB}/bin/mongod --dbpath ${PWD}/mongodb-linux-x86_64-${MONGODB}/data
      --logpath ${PWD}/mongodb-linux-x86_64-${MONGODB}/mongodb.log --fork"
    script:
    - go test ./... -coverprofile=coverage.out -covermode=atomic -p=1
    - sonar-scanner
    after_script:
    - pkill mongod
    after_success:
    - bash <(curl -s https://codecov.io/bash)
  - stage: deploy
    services: docker
    install: true
    script:
    - docker run -it -e JENKINS_AUTH_TOKEN=$JENKINS_AUTH_TOKEN -e JENKINS_BUILD_TOKEN=$JENKINS_BUILD_TOKEN
      -e JENKINS_BUILD_PROJECT=$TRAVIS_REPO_SLUG -e JENKINS_BUILD_BRANCH=$TRAVIS_BRANCH
      p1hub/p1jenkinstrigger
notifications:
  email: false
  slack:
    secure: b0jJIiQ0QXF2T3Pr/AZ8zZtmivmSKbYaTMuRbw0F4KRNmILPtCKYUK1sIHmwYmAC0INtuLIFWSqWKyMpGdIg+v2HGWohpKpxmOQeJWgMbxxDtS5jMIHloqNtsAuyMg8ILWT4aDoMF+0Rj/t9TnML92QnYUguBzH309BAMapOO6LiBAEOf0CLFafc7Fa+bsPijqQ7JaAT9xY59qD7Qi/mZ6N5wmDzBKfUA5D+uk29elONoaLoZhJLNg9hDRYf/BkKdn3wLDFuQ7O+j9NNXcPz4MpRxQyFoGqvKHQ+2fPf/zQRWYKUlO8n5eG6ntPA7kdMF2sa/06NIJUmySzDGJlarnVSdKU/vez+fNCD+NGu4pPSLX4qqY/th3SSszhJN9/x3S2YMCJtQDLSLBnhnOX6WNsaOFsCQwx1317YZs4OiZO1/IDLbDhrwkoQfHBLTwlYrusA+g0ErFlOB8yGXyFvksiwwXZL4CMLbfJT1/jpEV+M4Y6YiHxIPpqxmhjuwcF0fN47D8TZ7xq1NG9kj8QAgwbQr9bICnWtR+2SHr5YxgW3RlqacI2e4TVbU0+/6qwU3W5BEznkwDQzxK1ds8H3GnQkxVBCfTrY/F60ask8uwqt4NLCpHEjb6FcfZZCQgTfh86Ooc2E6QqKZGkcrhOqLxy7XoJ8hjfUUsRnTdoWPko=
env:
  global:
  - secure: OozocrFynrGUwNXvJZJoQZX2JdtnPor8birbXDWmxFqBPN8/wfBULPTkCeWlCFpg+DF4BcZNOIg89q2M0DW5NsgqCBxzRaBanwayFDSthgNf27JMZGl0wgz+LzWn9cBbJURDJO6nALGBXCXvRFgm+Us38tAlIEe8pSaCD3ppL8re1rxjRf9N5Jyqz6oBc+fAd1FQnpVHlZ8KdBtD+wRqcs46IZJuDdSU9Yx/w9ym2U26/+/y92vG0vpSOG73Ba2GsKdG1pPKk+fVoVHsaAuzZI/UJbDnkD6/6i556KRRGxtrBph3uE0utL0LpkWdNuc33EaEjnTqDiLsWgqxOFtFUg2mRvwgC+Bpix74vtsu8Qfigiwis6izvWvQcqMILvXP9Zq7HYEspb0QP2VLdHk7Zq+BjiiAiTlp1UuxQQE+nQFjlHXvk5eqqHyviHvOoVg47nh2RKqbKANBoDHDuZ8U8LXYs+HPrk77da0YKVs7XndyVYeo8RA/wTl8zDyiWwnpxKEqHq3CqEJLSca2hW+rM+7xgtOwXA7oF4pPWeBMd3rwYMIuZqJ2z5N4YshBbfUW4w5c/RX/tSefPvLVBB+VYNz//9YWbFLGoQFV0YaG1bWiKEBQTmCQ+iqCkE46JNNNAYjLK7oTu4EzwNBDwN6Nye8XAkVI+U4wExO1krL1Uco=
  - secure: BbKZ4WPtBQ4HhOaCqMvDyT9rGhqmetchMwXbtxpc2Tu0WVk8NdhLbMdXOI28hE11egEcqPLrALFgPeioxaPfZt6DSdNG8mvW2LuIMh1IxW5KkpexkqHCcXkh0J9Lg+ik4vxEp4zkSfAElpJDujrFpvxLCaIli6YdhclFlvAdd3ugWdoutq4XJAMWBJXhISUP7jbiNUzJ36oxMEAS+fWMH0cgqc9GcyN3MpyXsBVA/M1EFAXPvU2TBDyjszm5OYSaKu8lG7I5MO+eAhqplCdhQXe3g9gWitMgXqSRVKfewjzwS/mCH+haVYmCOVVgc7wVQdxp0YdRDlG2vCnEUcrpUQb1xC7T7OpHAG2aFy3eEmRzsWkQWWzllmrQlv4b/sLt5MDed3dR1skwerVU/R1+RRIYfZYdeLRVvGeLjOM/gs+vdDyB2jptLZaP2aTSVMMjBTsc6o2c946w3vw7ScOanD27b9sBhqKPcFXkhKZ7Lp/ZSurYgw0JSV3GMXiJYJOvc97vbRtoVqyFhTfnzcH1xGFoejCEaStVeDcJ5VWJCbrd+obD0/GygPGEYdmCckwk53pe5pWbo/zwlFDS/0CyPTQr4aaXUL0RmYiUMGb20eK0Cl2FI5GrlDXVkimcJmu0oLxNxts/PlxjenJhLX7H2/Yb488c03SpZH+qfw1ic2w=
  - secure: tn7435j9AYkX8mS5TITWnTZQrVtgir21spAgILLQYHkvCuDTAHXHMO8La852CcLQVN8sJETC9wSAxtGpRrniprEaa144/kAghqCTnYgd9shUIrHlsYQpRYYvx0HD3C6v6wNvjnCguE30zPkhNatSJAurmG86GdZsxN22PwBEpDrHf5WFnJFEoUzuHoMkWgAWvDmy/FmOx5SvInwmX2N+X+yfVmHy6067eyr19BdoZTBD/vYR8KaNIYunstL18o+9tsEeYIjnFBcAFB227+xae3Ybn6gdvT3/OPTY7JaAOmwyzuXOY9iv09WSlRX5/Nr2CMldhxu9CYdNHF1aNCvOcmJQjo6nL7/ZsGv67pqFLdvt0W77ElD7led4uNbaVS3dLCi1R07DdPPKB5Vdn81b5C1Uqt8TBNzSmn74UxEqIrMR3bj4InIkvibW1TSMMi8mvmFFMmn7mq4ODrduuaPVUyGSkt66832Hov9fW2Wq9dq+8SEo4Nxsm3Ap30lPUO8ZgaDzFApvGMgCBFRlZKdzmv/oVii2PMe4iHq1vYtGnf6dwWZxlfR88bVcjQrUKwYgVF0MJbBnOBl483AcTDVnNqelOomlzV3CZkqI6dfFlrhd3ITw+7T2HuznVJbWx/dvMT4/AH6jPFXwYbBDAiwhhRr2vGlpKlxs0wuDaS+XCEk=
  - secure: Y8w8L1ZoEmq7bNSNZnIBx/ln9oIKVxXbjshc+5A6BMDPLc3hO5RxjmHag3BH9tvJZwCcSfs5QUx2lK5XXe9Pn515aYUQCDFmt6iL9LJqJ8Vi/NvJcNyR6aLSODuHsKdzG0KxN/AX5EZjBd/qswL7xi65WtQm3gAq0O1C0dOSL+j7WtX6DBBgVlpHCycWeNIQNLXrkr0Dg6phSdlQHiuYKMiBc/CHg9jYfmVHYzNoURaZxuku/MwlzT1ZNjxahwzwy9Q+r5FZoi1jMdwypfd1aoD37vA2Loum+9u3gQTxKZQzVXruhaTff62+GhUlHGIAsLvIqenSJNcza4We9Jb7PtBRmoAE9MrK6EYnM+aXNmmo84wYNWbGINlmwirZyQp6dXzd/veNB7vnjOd+vcb32QcXQ2b1fUcdJYWXExhn7tbdI2BPtUrQFWw9pd2+TEA0t1aScQ8SSQBkdhz/EVveeJzFacKpL3i4IdUQr+KCiz6ZvnqOxe5djKS9HHjMX6DPKfxleWelcpYv6aqBeCA+PHraSTRdesMzBbPvyTgKHOAl17/LY9gW/J3/UOyXLfH4FRuWIgQdWtLEUbDRy5nsjaEz6lZr8bhp3xjXtu46ok92O2s8amGhLSWsGTUBr2x0eiH7JF/u5ZlCy4kitLWCQUZXwqFMkoMzdH7Wd5KbZGU=
